import fs from "fs";
import path from "path";
import { generateSpec } from "../generator/spec.js";
import { executeSpec } from "../generator/executor.js";
import { setCurrentRevision } from "../spec/currentRevision.js";

export default async function runFull({ prompt, buildRoot }) {
  if (!prompt) {
    throw new Error("Full mode requires prompt");
  }

  // Run generation normally
  const spec = generateSpec(prompt);
  await executeSpec(spec, buildRoot);

  // Find latest revision folder
  const revisions = fs.readdirSync(buildRoot, { withFileTypes: true })
    .filter(d => d.isDirectory())
    .map(d => d.name)
    .sort();

  if (revisions.length === 0) {
    throw new Error("No revision folders found in builds");
  }

  const revision = revisions[revisions.length - 1];

  setCurrentRevision(buildRoot, revision);

  return {
    mode: "full",
    revision,
    status: "ok"
  };
}
