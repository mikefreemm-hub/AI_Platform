import fs from "fs";
import path from "path";
import { getCurrentRevision } from "../spec/currentRevision.js";
import { generateSpec } from "../generator/spec.js";
import { executeSpec } from "../generator/executor.js";

export default async function runPage({ buildRoot, target }) {
  if (!target?.slug) {
    throw new Error("Page mode requires target.slug");
  }

  // 1. Resolve current revision
  const revision = getCurrentRevision(buildRoot);
  const revisionPath = path.join(buildRoot, revision);

  if (!fs.existsSync(revisionPath)) {
    throw new Error(`Revision folder not found: ${revision}`);
  }

  // 2. Regenerate spec (source of truth)
  const spec = generateSpec(`Edit page: ${target.slug}`);

  if (!spec.site || !Array.isArray(spec.site.pages)) {
    throw new Error("Generated spec missing site.pages");
  }

  // 3. Find target page
  const page = spec.site.pages.find(p => p.slug === target.slug);
  if (!page) {
    throw new Error(`Page not found in spec: ${target.slug}`);
  }

  const pageSpec = {
    ...spec,
    site: {
      ...spec.site,
      pages: [page]
    }
  };

  // 4. Regenerate only the target page
  await executeSpec(pageSpec, revisionPath);

  return {
    mode: "page",
    slug: target.slug,
    revision,
    status: "regenerated"
  };
}
