<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>AI Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{margin:0;background:#0b0e11;color:#e6e6e6;font-family:system-ui}
    .app{display:flex;height:100vh}
    .chat{width:380px;border-right:1px solid #1f2430;display:flex;flex-direction:column}
    .messages{flex:1;overflow:auto;padding:16px}
    .msg{margin-bottom:12px;padding:10px 12px;border-radius:12px;max-width:92%}
    .user{background:#1f2937;margin-left:auto}
    .assistant{background:#151922;color:#cbd5f5}
    .input{display:flex;gap:8px;padding:12px;border-top:1px solid #1f2430}
    input{flex:1;padding:10px;border-radius:10px;border:1px solid #333;background:#0b0e11;color:#fff}
    button{padding:10px 14px;border-radius:10px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    button:disabled{opacity:.6}
    iframe{flex:1;border:0;background:#000}
    .status{opacity:.7;font-size:13px;margin-top:4px}
  </style>
</head>
<body>

<div class="app">
  <div class="chat">
    <div id="messages" class="messages"></div>
    <div class="input">
      <input id="prompt" placeholder="Describe your website or a change…" />
      <button id="send">Send</button>
    </div>
  </div>
  <iframe id="preview"></iframe>
</div>

<script>
const messages = document.getElementById("messages");
const input = document.getElementById("prompt");
const sendBtn = document.getElementById("send");
const preview = document.getElementById("preview");

let currentPage = "index";

function addMessage(text, role="assistant"){
  const div = document.createElement("div");
  div.className = "msg " + role;
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function detectPageIntent(text){
  const t = text.toLowerCase();
  if(t.includes("home")) return "index";
  if(t.includes("about")) return "about";
  if(t.includes("gallery")) return "gallery";
  if(t.includes("contact")) return "contact";
  if(t.includes("dog breeds") || t.includes("breeds")) return "dog-breeds";
  return null;
}

async function send(){
  const text = input.value.trim();
  if(!text) return;

  addMessage(text, "user");
  input.value = "";
  sendBtn.disabled = true;

  const target = detectPageIntent(text);
  if(target) currentPage = target;

  try {
    addMessage("Thinking…");

    // Chat
    const chat = await fetch("/chat", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ message: text })
    });
    if(!chat.ok) throw new Error("Chat failed");

    // Export
    const exp = await fetch("/export", { method:"POST" });
    if(!exp.ok) throw new Error("Export failed");

    // Update preview
    preview.src =
      "/builds/default/index.html?page=" +
      currentPage +
      "&ts=" + Date.now();

    // Assistant confirmation
    addMessage(
      target
        ? `Updated the ${target.replace("-", " ")} page.`
        : "Updated the site."
    );

  } catch (e){
    addMessage("⚠️ " + e.message);
  } finally {
    sendBtn.disabled = false;
  }
}

sendBtn.onclick = send;
input.onkeydown = e => { if(e.key === "Enter") send(); };

// Initial load
preview.src = "/builds/default/index.html?page=index&ts=" + Date.now();
addMessage("Hi! Describe a website to generate, or tell me what to change.");
</script>

</body>
</html>
